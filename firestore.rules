rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get current user ID
    function getUserId() {
      return request.auth.uid;
    }
    
    // Helper function to check if user is organizer
    function isOrganizer(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.type == 'organizer';
    }
    
    // Helper function to check if user is participant
    function isParticipant(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.type == 'participant';
    }
    
    // Helper function to check if user is admin
    function isAdmin(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.type == 'admin';
    }
    
    // Users collection
    match /users/{userId} {
      // Users can read their own profile, organizers and admins can read all profiles
      allow read: if isAuthenticated() && (
        getUserId() == userId || 
        isOrganizer(getUserId()) || 
        isAdmin(getUserId())
      );
      
      // Users can create their own profile during signup
      allow create: if isAuthenticated() && 
        getUserId() == userId &&
        request.resource.data.keys().hasAll(['email', 'name', 'universityId', 'type']);
      
      // Users can update their own profile, admins can update any profile
      allow update: if isAuthenticated() && (
        getUserId() == userId ||
        isAdmin(getUserId())
      );
      
      // Only admins can delete users (and cannot delete themselves)
      allow delete: if isAuthenticated() && 
        isAdmin(getUserId()) && 
        getUserId() != userId;
    }
    
    // Events collection
    match /events/{eventId} {
      // Anyone authenticated can read events
      allow read: if isAuthenticated();

      function isOrganizerOrAdminUpdatingOwnEvent() {
        return isAuthenticated() && (
          (isOrganizer(getUserId()) && resource.data.organizerId == getUserId()) ||
          isAdmin(getUserId())
        );
      }

      function isParticipantUpdatingRegistration() {
        let uid = getUserId();
        let current = resource.data.participants == null ? [] : resource.data.participants;
        let next = request.resource.data.participants == null ? [] : request.resource.data.participants;
        let wasRegistered = current.hasAny([uid]);
        let willBeRegistered = next.hasAny([uid]);
        let sizeDiff = next.size() - current.size();
        
        // Only allow changes to participants array
        let onlyParticipantsChanged = request.resource.data.diff(resource.data).changedKeys().hasOnly(['participants']);
        
        // Validate participant can only add/remove themselves
        let onlySelfChange = (!wasRegistered && willBeRegistered && sizeDiff == 1 && next.hasAny([uid])) ||
                            (wasRegistered && !willBeRegistered && sizeDiff == -1 && !next.hasAny([uid]));

        return isAuthenticated() &&
               isParticipant(uid) &&
               onlyParticipantsChanged &&
               onlySelfChange;
      }
      
      // Only organizers can create events (admins can also create)
      allow create: if isAuthenticated() && (
        (isOrganizer(getUserId()) && request.resource.data.organizerId == getUserId()) ||
        isAdmin(getUserId())
      ) &&
      request.resource.data.keys().hasAll(['id', 'title', 'organizerId', 'date', 'createdAt']) &&
      (request.resource.data.participants == null || request.resource.data.participants.size() <= 10000);
      
      // Event organizer or admin can update events
      allow update: if isOrganizerOrAdminUpdatingOwnEvent() || isParticipantUpdatingRegistration();
      
      // Event organizer or admin can delete events
      allow delete: if isAuthenticated() && (
        (isOrganizer(getUserId()) && resource.data.organizerId == getUserId()) ||
        isAdmin(getUserId())
      );
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      // Users can read their own notifications, organizers and admins can read all
      allow read: if isAuthenticated() && (
        resource.data.userId == getUserId() ||
        isOrganizer(getUserId()) ||
        isAdmin(getUserId())
      );
      
      // Organizers and admins can create notifications (when creating events)
      allow create: if isAuthenticated() && 
        (isOrganizer(getUserId()) || isAdmin(getUserId())) &&
        request.resource.data.keys().hasAll(['userId', 'title', 'message', 'timestamp']);
      
      // Users can update their own notifications to mark them as read (only the 'read' field)
      allow update: if isAuthenticated() && 
        resource.data.userId == getUserId() &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']) &&
        request.resource.data.read == true;
    }
    
    // Organizer Requests collection
    match /organizer_requests/{requestId} {
      // Users can read their own requests, Admins can read all requests
      allow read: if isAuthenticated() && (
        isAdmin(getUserId()) || 
        resource.data.userId == getUserId()
      );
      
      // Users can create their own organizer requests during signup
      allow create: if isAuthenticated() && request.resource.data.userId == getUserId();
      
      // Only admins can update organizer requests (approve/reject)
      allow update: if isAuthenticated() && isAdmin(getUserId());
      
      // Only admins can delete organizer requests
      allow delete: if isAuthenticated() && isAdmin(getUserId());
    }
    
    // Event Participants collection - stores participant registration info
    match /event_participants/{participantId} {
      // Organizers and admins can read all participant info
      // Participants can read their own registration info
      allow read: if isAuthenticated() && (
        isAdmin(getUserId()) ||
        isOrganizer(getUserId()) ||
        (resource != null && resource.data.userId == getUserId())
      );
      
      // Participants can create their own registration info
      allow create: if isAuthenticated() && 
        isParticipant(getUserId()) &&
        request.resource.data.userId == getUserId() &&
        request.resource.data.eventId != null &&
        request.resource.data.keys().hasAll(['userId', 'eventId']);
      
      // Participants can update their own registration info
      // Organizers and admins can update any participant info (for approvals/rejections)
      allow update: if isAuthenticated() && (
        (resource.data.userId == getUserId() && request.resource.data.userId == getUserId()) ||
        isAdmin(getUserId()) ||
        isOrganizer(getUserId())
      );
      
      // Organizers and admins can delete participant info
      allow delete: if isAuthenticated() && (
        isAdmin(getUserId()) ||
        isOrganizer(getUserId())
      );
    }
    
    // Expense Tracker collection - stores event expenses
    match /event_expenses/{expenseId} {
      // Allow organizers and admins to read expenses
      // Note: For list queries with where('eventId', '==', eventId), 
      // Firestore will only return documents that match the query
      allow read: if isAuthenticated() && (
        isAdmin(getUserId()) ||
        isOrganizer(getUserId())
      );
      
      // Allow organizers and admins to create expenses
      allow create: if isAuthenticated() && (
        isAdmin(getUserId()) ||
        isOrganizer(getUserId())
      ) && request.resource.data.createdBy == getUserId() &&
      request.resource.data.keys().hasAll(['eventId', 'category', 'description', 'amount', 'date', 'createdBy', 'createdAt', 'paymentMethod']);
      
      // Allow users to update their own expenses, or admins to update any
      allow update: if isAuthenticated() && (
        isAdmin(getUserId()) ||
        (resource.data.createdBy == getUserId() && isOrganizer(getUserId()))
      );
      
      // Allow users to delete their own expenses, or admins to delete any
      allow delete: if isAuthenticated() && (
        isAdmin(getUserId()) ||
        (resource.data.createdBy == getUserId() && isOrganizer(getUserId()))
      );
    }
    
    // App Settings collection - stores app-wide settings like meal service
    match /app_settings/{settingsId} {
      // All authenticated users can read settings (students need to see meal status)
      allow read: if isAuthenticated();
      
      // Only admins can create/update/delete settings
      allow write: if isAuthenticated() && isAdmin(getUserId());
    }
    
    // Default deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

